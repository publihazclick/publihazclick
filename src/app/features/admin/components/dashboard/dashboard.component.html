<div class="space-y-6">

  <!-- ── Loading ── -->
  @if (loading()) {
    <div class="flex flex-col items-center justify-center py-24">
      <span class="material-symbols-outlined text-primary text-5xl animate-spin mb-4">sync</span>
      <p class="text-slate-400 text-sm">Cargando datos...</p>
    </div>
  }

  <!-- ── Error ── -->
  @if (error() && !loading()) {
    <div class="bg-rose-500/10 border border-rose-500/20 rounded-xl p-4 flex items-center gap-3">
      <span class="material-symbols-outlined text-rose-500 flex-shrink-0">error</span>
      <p class="text-rose-400 text-sm flex-1">{{ error() }}</p>
      <button (click)="reloadData()"
        class="px-3 py-1.5 bg-rose-500 hover:bg-rose-600 text-white rounded-lg text-xs font-bold transition-colors">
        Reintentar
      </button>
    </div>
  }

  @if (!loading() && !error()) {

    <!-- ── Page header ── -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-black text-white">Vista General</h1>
        <p class="text-slate-400 text-sm">Métricas y actividad del sistema en tiempo real</p>
      </div>
      <button (click)="reloadData()"
        class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 text-slate-300 rounded-xl font-bold text-sm transition-colors self-start sm:self-auto">
        <span class="material-symbols-outlined text-xl">refresh</span>
        Actualizar
      </button>
    </div>

    <!-- ══ FILA 1: KPIs ══ -->
    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-3">

      <!-- Usuarios -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl bg-blue-500/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-blue-400" style="font-size:18px">group</span>
          </div>
          @if ((stats()?.newUsersToday ?? 0) > 0) {
            <span class="px-2 py-0.5 bg-emerald-500/10 text-emerald-400 rounded text-[10px] font-bold uppercase">
              +{{ stats()?.newUsersToday }} hoy
            </span>
          }
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Usuarios</p>
        <p class="text-2xl font-black text-white">{{ formatNumber(stats()?.totalUsers) }}</p>
        <p class="text-xs text-slate-500 mt-1">{{ formatNumber(stats()?.activeUsers) }} activos</p>
      </div>

      <!-- Anuncios -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl bg-primary/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-primary" style="font-size:18px">ads_click</span>
          </div>
          @if ((stats()?.pendingAds ?? 0) > 0) {
            <span class="px-2 py-0.5 bg-amber-500/10 text-amber-400 rounded text-[10px] font-bold uppercase">
              {{ stats()?.pendingAds }} pend.
            </span>
          }
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Anuncios</p>
        <p class="text-2xl font-black text-white">{{ formatNumber(stats()?.activeAds) }}</p>
        <p class="text-xs text-slate-500 mt-1">de {{ formatNumber(stats()?.totalAds) }} totales</p>
      </div>

      <!-- Clicks hoy -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl bg-accent/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-accent" style="font-size:18px">touch_app</span>
          </div>
          <span class="px-2 py-0.5 bg-white/5 text-slate-500 rounded text-[10px] font-bold uppercase">hoy</span>
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Clicks</p>
        <p class="text-2xl font-black text-white">{{ formatNumber(stats()?.todayClicks) }}</p>
        <p class="text-xs text-slate-500 mt-1">{{ formatNumber(stats()?.totalClicks) }} total</p>
      </div>

      <!-- Pagado hoy -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl bg-emerald-500/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-emerald-400" style="font-size:18px">payments</span>
          </div>
          <span class="px-2 py-0.5 bg-white/5 text-slate-500 rounded text-[10px] font-bold uppercase">hoy</span>
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Pagado</p>
        <p class="text-lg font-black text-white leading-tight">{{ formatCurrency(stats()?.todayRevenue) }}</p>
        <p class="text-xs text-slate-500 mt-1">{{ formatCurrency(stats()?.totalPaidOut) }} acum.</p>
      </div>

      <!-- Donaciones -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl bg-pink-500/10 flex items-center justify-center">
            <span class="material-symbols-outlined text-pink-400" style="font-size:18px">volunteer_activism</span>
          </div>
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Donaciones</p>
        <p class="text-lg font-black text-white leading-tight">{{ formatCurrency(stats()?.totalDonated) }}</p>
        <p class="text-xs text-slate-500 mt-1">acumulado</p>
      </div>

      <!-- Retiros pendientes -->
      <div class="bg-card-dark rounded-2xl p-4 border border-white/5">
        <div class="flex items-center justify-between mb-4">
          <div class="w-9 h-9 rounded-xl flex items-center justify-center"
            [class.bg-amber-500/10]="(stats()?.pendingWithdrawals ?? 0) > 0"
            [class.bg-white/5]="(stats()?.pendingWithdrawals ?? 0) === 0">
            <span class="material-symbols-outlined" style="font-size:18px"
              [class.text-amber-400]="(stats()?.pendingWithdrawals ?? 0) > 0"
              [class.text-slate-500]="(stats()?.pendingWithdrawals ?? 0) === 0">
              schedule_send
            </span>
          </div>
          @if ((stats()?.pendingWithdrawals ?? 0) > 0) {
            <span class="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
          }
        </div>
        <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest mb-1">Retiros</p>
        <p class="text-2xl font-black"
          [class.text-amber-400]="(stats()?.pendingWithdrawals ?? 0) > 0"
          [class.text-white]="(stats()?.pendingWithdrawals ?? 0) === 0">
          {{ formatNumber(stats()?.pendingWithdrawals) }}
        </p>
        <p class="text-xs text-slate-500 mt-1">{{ formatNumber(stats()?.totalWithdrawals) }} completados</p>
      </div>
    </div>

    <!-- ══ FILA 2: Gráfico + Actividad ══ -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

      <!-- Gráfico 7 días -->
      <div class="xl:col-span-2 bg-card-dark rounded-2xl border border-white/5 overflow-hidden">
        <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h2 class="font-black text-white text-base">Actividad — últimos 7 días</h2>
            <p class="text-xs text-slate-500 mt-0.5">Usuarios registrados vs Clicks en anuncios</p>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-1.5">
              <span class="w-2.5 h-2.5 rounded-sm bg-primary/60"></span>
              <span class="text-xs text-slate-400 font-bold uppercase tracking-widest">Usuarios</span>
            </div>
            <div class="flex items-center gap-1.5">
              <span class="w-2.5 h-2.5 rounded-sm bg-accent/60"></span>
              <span class="text-xs text-slate-400 font-bold uppercase tracking-widest">Clicks</span>
            </div>
          </div>
        </div>

        <div class="p-6">
          @if (chartData(); as chart) {
            @if (chart.labels.length > 0) {
              <div class="h-48 flex items-end justify-between gap-2">
                @for (label of chart.labels; track $index; let i = $index) {
                  <div class="flex-1 flex flex-col items-center gap-1.5 group cursor-default relative">
                    <!-- Tooltip -->
                    <div class="absolute bottom-full mb-2 left-1/2 -translate-x-1/2 hidden group-hover:flex flex-col items-center gap-0.5 bg-zinc-900 border border-white/10 rounded-lg px-2.5 py-2 text-[10px] whitespace-nowrap z-10 shadow-xl">
                      <span class="text-white font-bold text-xs">{{ label }}</span>
                      @if (chart.datasets[0]) {
                        <span class="text-primary font-bold">{{ chart.datasets[0].data[i] }} usuarios</span>
                      }
                      @if (chart.datasets[1]) {
                        <span class="text-accent font-bold">{{ chart.datasets[1].data[i] }} clicks</span>
                      }
                    </div>
                    <!-- Barras -->
                    <div class="w-full flex gap-0.5 items-end justify-center h-44">
                      @if (chart.datasets[0]; as ds) {
                        @let max0 = (ds.data | max) || 1;
                        <div class="flex-1 rounded-t-md bg-primary/40 hover:bg-primary/70 transition-colors min-h-[4px]"
                          [style.height]="getBarHeight(ds.data[i] || 0, max0)"></div>
                      }
                      @if (chart.datasets[1]; as ds) {
                        @let max1 = (ds.data | max) || 1;
                        <div class="flex-1 rounded-t-md bg-accent/50 hover:bg-accent/80 transition-colors min-h-[4px]"
                          [style.height]="getBarHeight(ds.data[i] || 0, max1)"></div>
                      }
                    </div>
                    <span class="text-[10px] font-bold text-slate-500">{{ label }}</span>
                  </div>
                }
              </div>
            } @else {
              <div class="h-48 flex flex-col items-center justify-center gap-3">
                <span class="material-symbols-outlined text-slate-700 text-5xl">bar_chart</span>
                <p class="text-slate-500 text-sm">Sin actividad en los últimos 7 días</p>
              </div>
            }
          }
        </div>
      </div>

      <!-- Actividad reciente -->
      <div class="bg-card-dark rounded-2xl border border-white/5 overflow-hidden flex flex-col">
        <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h2 class="font-black text-white text-base">Actividad Reciente</h2>
            <p class="text-xs text-slate-500 mt-0.5">Últimas acciones del sistema</p>
          </div>
          <a routerLink="/admin/logs" class="text-xs text-primary font-bold hover:underline uppercase tracking-wide">
            Ver logs
          </a>
        </div>

        <div class="flex-1 divide-y divide-white/5">
          @if (recentActivity().length > 0) {
            @for (activity of recentActivity(); track activity.id) {
              <div class="px-5 py-3.5 flex items-start gap-3 hover:bg-white/[0.03] transition-colors">
                <div class="w-8 h-8 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0 mt-0.5">
                  <span class="material-symbols-outlined text-primary" style="font-size:14px">
                    {{ activity.action.includes('user') ? 'person' :
                       activity.action.includes('withdrawal') ? 'payments' :
                       activity.action.includes('ad') || activity.action.includes('approve') ? 'ads_click' : 'history' }}
                  </span>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-bold text-white truncate">{{ activity.username }}</p>
                  <p class="text-xs text-slate-400 mt-0.5">{{ getActionText(activity.action) }}</p>
                  <p class="text-xs text-slate-600 mt-0.5">{{ formatDate(activity.created_at) }}</p>
                </div>
              </div>
            }
          } @else {
            <div class="flex flex-col items-center justify-center py-10 gap-3">
              <span class="material-symbols-outlined text-slate-700 text-4xl">history</span>
              <p class="text-slate-500 text-sm">Sin actividad reciente</p>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- ══ FILA 3: Moderación + Resumen ══ -->
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

      <!-- Moderación pendiente -->
      <div class="xl:col-span-2 bg-card-dark rounded-2xl border border-white/5 overflow-hidden">
        <div class="px-6 py-4 border-b border-white/5 flex items-center justify-between">
          <div>
            <h2 class="font-black text-white text-base">Moderación Pendiente</h2>
            <p class="text-xs text-slate-500 mt-0.5">Campañas en espera de aprobación</p>
          </div>
          <a routerLink="/admin/ads" class="text-xs text-primary font-bold hover:underline uppercase tracking-wide">
            Ver todo
          </a>
        </div>

        @if (hasPendingAds()) {
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="bg-white/5 text-xs font-black uppercase text-slate-400 tracking-widest">
                  <th class="px-6 py-4">Campaña</th>
                  <th class="px-6 py-4 hidden sm:table-cell">Anunciante</th>
                  <th class="px-6 py-4 hidden md:table-cell">Fecha</th>
                  <th class="px-6 py-4 text-right">Acciones</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/5">
                @for (item of pendingItems(); track item.id) {
                  <tr class="hover:bg-white/[0.03] transition-colors">
                    <td class="px-6 py-4">
                      <div class="flex items-center gap-3">
                        <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center flex-shrink-0">
                          <span class="material-symbols-outlined text-primary" style="font-size:16px">campaign</span>
                        </div>
                        <div class="min-w-0">
                          <p class="font-bold text-white text-sm truncate">{{ item.title }}</p>
                          <p class="text-xs text-slate-500 font-mono">{{ item.id | slice:0:8 }}…</p>
                        </div>
                      </div>
                    </td>
                    <td class="px-6 py-4 hidden sm:table-cell">
                      <span class="text-sm text-white font-medium">{{ item.advertiser_username }}</span>
                    </td>
                    <td class="px-6 py-4 hidden md:table-cell">
                      <span class="text-sm text-slate-400">{{ formatDate(item.submitted_at) }}</span>
                    </td>
                    <td class="px-6 py-4">
                      <div class="flex justify-end gap-1.5">
                        <button (click)="rejectAd(item.id)"
                          class="px-3 py-1.5 bg-rose-500/10 text-rose-400 hover:bg-rose-500 hover:text-white rounded-lg text-xs font-bold transition-colors uppercase">
                          Rechazar
                        </button>
                        <button (click)="approveAd(item.id)"
                          class="px-3 py-1.5 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500 hover:text-white rounded-lg text-xs font-bold transition-colors uppercase">
                          Aprobar
                        </button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="p-12 flex flex-col items-center gap-3">
            <div class="w-14 h-14 bg-emerald-500/10 rounded-2xl flex items-center justify-center">
              <span class="material-symbols-outlined text-emerald-400 text-3xl">check_circle</span>
            </div>
            <p class="font-bold text-white">¡Todo al día!</p>
            <p class="text-sm text-slate-500">No hay campañas pendientes de moderación</p>
          </div>
        }
      </div>

      <!-- Resumen del sistema -->
      <div class="bg-card-dark rounded-2xl border border-white/5 overflow-hidden">
        <div class="px-6 py-4 border-b border-white/5">
          <h2 class="font-black text-white text-base">Resumen del Sistema</h2>
          <p class="text-xs text-slate-500 mt-0.5">Indicadores clave de la plataforma</p>
        </div>

        <!-- Métricas -->
        <div class="divide-y divide-white/5">
          <div class="px-6 py-3.5 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              <span class="w-2 h-2 rounded-full bg-emerald-400 flex-shrink-0"></span>
              <span class="text-sm text-slate-400">Usuarios activos</span>
            </div>
            <span class="font-bold text-emerald-400 text-sm">{{ formatNumber(stats()?.activeUsers) }}</span>
          </div>
          <div class="px-6 py-3.5 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              <span class="w-2 h-2 rounded-full bg-primary flex-shrink-0"></span>
              <span class="text-sm text-slate-400">Anuncios activos</span>
            </div>
            <span class="font-bold text-primary text-sm">{{ formatNumber(stats()?.activeAds) }}</span>
          </div>
          <div class="px-6 py-3.5 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              <span class="w-2 h-2 rounded-full bg-accent flex-shrink-0"></span>
              <span class="text-sm text-slate-400">Total clicks</span>
            </div>
            <span class="font-bold text-accent text-sm">{{ formatNumber(stats()?.totalClicks) }}</span>
          </div>
          <div class="px-6 py-3.5 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              <span class="w-2 h-2 rounded-full bg-amber-400 flex-shrink-0"></span>
              <span class="text-sm text-slate-400">Retiros pendientes</span>
            </div>
            <span class="font-bold text-sm"
              [class.text-amber-400]="(stats()?.pendingWithdrawals ?? 0) > 0"
              [class.text-slate-500]="(stats()?.pendingWithdrawals ?? 0) === 0">
              {{ formatNumber(stats()?.pendingWithdrawals) }}
            </span>
          </div>
          <div class="px-6 py-3.5 flex items-center justify-between">
            <div class="flex items-center gap-2.5">
              <span class="w-2 h-2 rounded-full bg-pink-400 flex-shrink-0"></span>
              <span class="text-sm text-slate-400">Total donado</span>
            </div>
            <span class="font-bold text-pink-400 text-sm">{{ formatCurrency(stats()?.totalDonated) }}</span>
          </div>
        </div>

        <!-- Ingresos hoy -->
        <div class="p-5 border-t border-white/5">
          <div class="bg-slate-900 rounded-xl p-4 border border-white/5">
            <div class="flex items-center justify-between mb-3">
              <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Pagado hoy</span>
              <span class="text-sm font-black text-primary">{{ formatCurrency(stats()?.todayRevenue) }}</span>
            </div>
            <div class="w-full bg-white/5 rounded-full h-1.5">
              <div class="bg-primary rounded-full h-1.5 transition-all duration-700"
                [style.width.%]="Math.min(((stats()?.todayRevenue ?? 0) / Math.max((stats()?.totalPaidOut ?? 1), 1)) * 100, 100)">
              </div>
            </div>
            <p class="text-xs text-slate-600 mt-2">Total acumulado: {{ formatCurrency(stats()?.totalPaidOut) }}</p>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="px-5 pb-5 grid grid-cols-2 gap-2">
          <a routerLink="/admin/users"
            class="flex items-center gap-2 px-3 py-2.5 bg-white/5 hover:bg-primary/10 border border-white/5 hover:border-primary/20 rounded-xl transition-colors">
            <span class="material-symbols-outlined text-primary" style="font-size:18px">manage_accounts</span>
            <span class="text-xs font-bold text-slate-300">Usuarios</span>
          </a>
          <a routerLink="/admin/ads"
            class="flex items-center gap-2 px-3 py-2.5 bg-white/5 hover:bg-accent/10 border border-white/5 hover:border-accent/20 rounded-xl transition-colors">
            <span class="material-symbols-outlined text-accent" style="font-size:18px">campaign</span>
            <span class="text-xs font-bold text-slate-300">Anuncios</span>
          </a>
          <a routerLink="/admin/ads"
            class="flex items-center gap-2 px-3 py-2.5 bg-white/5 hover:bg-amber-500/10 border border-white/5 hover:border-amber-500/20 rounded-xl transition-colors">
            <span class="material-symbols-outlined text-amber-400" style="font-size:18px">campaign</span>
            <span class="text-xs font-bold text-slate-300">Gestión Ads</span>
          </a>
          <a routerLink="/admin/reports"
            class="flex items-center gap-2 px-3 py-2.5 bg-white/5 hover:bg-emerald-500/10 border border-white/5 hover:border-emerald-500/20 rounded-xl transition-colors">
            <span class="material-symbols-outlined text-emerald-400" style="font-size:18px">bar_chart</span>
            <span class="text-xs font-bold text-slate-300">Reportes</span>
          </a>
        </div>
      </div>
    </div>

  }
</div>
